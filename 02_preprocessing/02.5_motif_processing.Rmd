---
title: "02.5 Motif Processing"
output: html_document
date: '2025-21-01'
params: 
  motifDir: 
    label: "motifDir"
    value: ./motifData
---

```{r, setup}
suppressPackageStartupMessages({
  library(BiocParallel)
  library(data.table)
  library(HDF5Array)
  library(TFBlearner)
  library(GenomeInfoDb)
})
```

```{r, paths}
motifDir <- params$motifDir

coordsPath <- "../data/hybrid.custom.hg38.resized.resplit.rds"
chIPMetaPath <- "../data/meta_data/01_fullMetaChIPAll.rds"
```

## Data specification

### Motif Data

```{r, load meta data}
chIPMeta <- readRDS(chIPMetaPath)
allCoveredTfs <- unique(chIPMeta$tf_name)
allCoveredTfs <- allCoveredTfs[!is.na(allCoveredTfs)]
```

### Motif names

```{r}
motifFiles <- list.files(motifDir, full.names=TRUE)
motifFiles <- motifFiles[grepl(".rds", motifFiles)]
motifNames <- basename(motifFiles)
motifNames <- unlist(tstrsplit(motifNames, split=".", fixed=TRUE, keep=1))
```

### Reference Coordinates

```{r}
# DHS sites + mouse liftover DHS + ATLAS ATAC peaks
coords <- readRDS(coordsPath)
```

### Cofactors

```{r, get the cofactors}
library(OmnipathR)
library(tidyr)

  # get the cofactors
cofactors <- as.data.table(import_omnipath_interactions() %>% as_tibble())
# get tf-tf (prot) interactions
cofactors <- subset(cofactors, source_genesymbol %in% motifNames &   
                               target_genesymbol %in% motifNames)
# either source or target needs to be amongst the covered tfs
cofactors <- subset(cofactors, target_genesymbol %in% allCoveredTfs | 
                               source_genesymbol %in% allCoveredTfs)
allCofactors <- unique(c(cofactors$target_genesymbol, 
                         cofactors$source_genesymbol))
allTfs <- unique(c(allCofactors, allCoveredTfs))
saveRDS(allTfs, "../data/allTfs.rds")
saveRDS(allCofactors, "../data/allCofactors.rds")
```

### Motif

TFs being profiled
All for which we have data + their cofactors
```{r, gathering motif names}
motifFiles <- list.files(motifDir, full.names=TRUE)
motifFiles <- motifFiles[grepl(".rds", motifFiles)]
motifNames <- basename(motifFiles)
motifNames <- unlist(tstrsplit(motifNames, split=".", fixed=TRUE, keep=1))
# subset to the ones either covered or being cofactors of covered
whichTfs <- motifNames %in% allTfs

allMotifNames <- motifNames[whichTfs]
motifFiles <- motifFiles[whichTfs]
motifNames <- motifNames[whichTfs]
```

```{r, preparing  motifs data, eval=TRUE}
for(motifName in motifNames){
  
  motif <- readRDS(file.path(motifDir, paste0(motifName, ".rds")))
  motif <- as.data.table(motif)
  setnames(motif, "seqnames", "chr")
  
  saveRDS(motif, file.path("../data/motifs",
                           paste0(paste(motifName, "motif", sep="_"), ".rds")))
}
```

```{r, preparing dimer motifs data, eval=TRUE}
dimerMotifs <- readRDS("../data/motifs/dhs_dimer_motif_scoreMatrix.rds")

for(dimer in colnames(dimerMotifs)){
  motif <- data.table(score=dimerMotifs[,dimer, drop=TRUE])
  motif <- cbind(as.data.table(coords), motif)
  setnames(motif, "seqnames", "chr")
  dimer <- gsub("_", ":", dimer)
  
  saveRDS(motif, file.path("../data/motifs",
                           paste0(paste(dimer, "dimerMotif", sep="_"), ".rds")))
}
```

```{r, preparing dinuc motifs data, eval=TRUE}
dinucMotifs <- readRDS("../data/motifs/dhs_dinuc_motif_scoreMatrix.rds")

for(dinuc in colnames(dinucMotifs)){
  motif <- data.table(score=dinucMotifs[,dinuc, drop=TRUE])
  motif <- cbind(as.data.table(coords), motif)
  setnames(motif, "seqnames", "chr")
  dinuc <- gsub("_", ":", dinuc)
  
  saveRDS(motif, file.path("../data/motifs",
                           paste0(paste(dinuc, "dinucMotif", sep="_"), ".rds")))
}
```

```{r, sessioninfo}
sessionInfo()
```
