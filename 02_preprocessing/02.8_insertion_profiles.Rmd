---
title: "02.8 Insertion profiles"
output: html_document
date: '2023-07-05'
params: 
  motifDir: 
    label: "motifDir"
    value: ./motifData
  outDir:
    label: "outDir"
    value: ./insertsion
---

```{r, setup}
suppressPackageStartupMessages({
  library(phastCons100way.UCSC.hg38)
  library(BSgenome.Hsapiens.UCSC.hg38)
  library(EnsDb.Hsapiens.v86)
  library(ggplot2)
  library(viridis)
  library(patchwork)
  library(RColorBrewer)
  library(TFBlearner)
})
```

```{r, paths}
allTfs <- readRDS("../data/allTfs.rds")
maePath <- "./mae_small/mae_small_hdf5.rds" #"../data/mae_all.rds"

motifDir <- params$motifDir
outDir <- params$outDir
if(!dir.exists(outDir)) dir.create(outDir)
```

# Calculate Profile for each cellular context X Tf

```{r, per context profiles, eval=TRUE, error=TRUE}
mae <- readRDS(maePath)
allTfs <- intersect(allTfs, colData(mae[["ChIP"]])$tfName)
maxScores <- colData(mae[["Motifs"]])[,c("motifName", "maxScore")]
maxScores <- as.data.table(maxScores)
maxScores[,maxScore:=maxScore/TFBlearner:::scalFactMotif]

# subset to training only data
cols <- lapply(experiments(mae), function(n) {
        colnames(n)[colnames(n) %in% unique(subset(sampleMap(mae), 
            isTraining)$colname)]})
mae <- subsetByColumn(mae, cols)

refCoords <- rowRanges(experiments(mae)$Motifs)
chIPMeta <- as.data.table(subset(sampleMap(mae), assay=="ChIP"))
atacMeta <- as.data.table(subset(colData(experiments(mae)$ATAC)))
chIPMeta[,c("context", "tf"):=tstrsplit(colname, split="_", keep=1:2)]

lapply(allTfs, function(tfI){
  tryCatch({
  contexts <- unique(subset(chIPMeta, tf==tfI)$context)
  motifFileName <- file.path(motifDir, paste0(tfI, ".rds"))
  maxScore <- subset(maxScores, motifName==tfI)$maxScore

  if(file.exists(motifFileName)){
    motifMatches <- readRDS(file.path(motifDir, paste0(tfI, ".rds")))
    motifMatches <- motifMatches[motifMatches$score>=(maxScore/2)]
    seqlevelsStyle(motifMatches) <- seqlevelsStyle(refCoords)
    motifMatches <- subsetByOverlaps(motifMatches, refCoords)
  
  lapply(contexts, function(contextI){
    if(file.exists(file.path(outDir, paste0(paste(tfI, contextI, sep="-")), ".rds"))){
      return(NULL)
    }
    atacPath <- unlist(unique(subset(atacMeta, context==contextI)$origin))
    fragData <- lapply(atacPath, TFBlearner:::.processData, shift=FALSE)
    fragData <- rbindlist(fragData)
    
    # subset by overlapping ChIP-peak
    rs <- rowSums(assays(experiments(mae)$ChIP)$peaks[,paste(contextI,tfI, sep="_"),drop=FALSE])
    pki <- which(rs>0.5)
    motifSubMatches <- subsetByOverlaps(motifMatches,rowRanges(experiments(mae)$ChIP)[pki])

    if(length(motifSubMatches)>0){
      motifSubMatches$motif_id <- tfI
      ins <- suppressWarnings(getInsertionProfiles(atacData=fragData,
                                  motifRanges=motifSubMatches,
                                  margin=200,
                                  calcProfile=TRUE,
                                  stranded=TRUE,
                                  shift=FALSE,
                                  symmetric=FALSE))
      gc()
      saveRDS(ins$insertProfiles, 
              file.path(outDir, paste0(paste(tfI, contextI, sep="_"), ".rds")))
    return(NULL)}
    else{
      return(NULL)
    }
  })}
  else{
    return(NULL)
  }},
  error=function(cond){
    message(paste("Could not compute insertion profiles for", tfI))
    message(conditionMessage(cond))
    return(NULL)
  }
  )
})
```


# Insertion Profiles

```{r, mean/median profiles, eval=TRUE, error=TRUE}
mae <- readRDS(maePath)

# subset to training only data
cols <- lapply(experiments(mae), function(n) {
        colnames(n)[colnames(n) %in% unique(subset(sampleMap(mae), 
            isTraining)$colname)]})
mae <- subsetByColumn(mae, cols)

refCoords <- rowRanges(experiments(mae)$Motifs)
chIPMeta <- as.data.table(subset(sampleMap(mae), assay=="ChIP"))
atacMeta <- as.data.table(subset(colData(experiments(mae)$ATAC)))
chIPMeta[,c("context", "tf"):=tstrsplit(colname, split="_", keep=1:2)]

insFiles <- list.files(outDir)
insFiles <- insFiles[!grepl("median", insFiles) & !grepl("_plot", insFiles)]
insFiles <- data.table(file_name=insFiles)
insFiles[,c("tf", "context"):=tstrsplit(file_name, split="_", keep=1:2)]
insFiles[,context:=substr(context, 1, nchar(context)-4)]

lapply(unique(chIPMeta$tf), function(tfI){
  subInsFiles <- subset(insFiles, tf==tfI)
  if(nrow(subInsFiles)>0){
    paths <- file.path(outDir, subInsFiles$file_name)
  
    profiles <- lapply(paths, readRDS)
    names(profiles) <- subInsFiles$context
  
    profiles <- rbindlist(profiles, idcol="context")
    profilesMean <- profiles[,.(w=median(w, na.rm=TRUE)), by=rel_pos]
    profilesMean[,w_smooth:=as.numeric(smooth(w, twiceit=TRUE))]
  
    profilesMean$context <- "median"
    medianProfilePlot <- ggplot(profiles, aes(x=rel_pos, y=w, group=context))+
      geom_line(color="darkgrey", alpha=0.7)+
      geom_line(color="grey",aes(x=rel_pos, y=w_smooth), alpha=0.7)+
      geom_line(data=profilesMean, mapping=aes(x=rel_pos, y=w, context="median"), 
              color="darkred")+
      geom_line(data=profilesMean, mapping=aes(x=rel_pos, y=w_smooth, context="median"), 
              color="red")+
      ggtitle(tfI)+
      theme_bw()
    ggsave(file.path(outDir, paste(tfI, "plot.png", sep="_")), medianProfilePlot)
  
    gc()
    saveRDS(profilesMean, file.path(outDir, paste(tfI, "median.rds", sep="_")))
  }
  else{
    return(NULL)
  }
})
```
